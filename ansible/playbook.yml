---
- name: Deploy Production VS Code Server with Nginx & Let's Encrypt
  hosts: vscode_servers
  become: true

  vars:
    domain_name: "ide.ucclab.io"
    admin_email: "admin@ucclab.io"
    code_server_password: "{{ vault_code_server_password }}"
    project_directory: "/opt/vscode-server"
    timezone: "UTC"
    letsencrypt_environment: "production"
    backup_directory: "/var/backups/vscode-server"

    # üîí SAFETY CONTROLS ‚Äî NEVER DESTROYS DATA BY DEFAULT
    docker_allow_data_wipe: false
    docker_wipe_confirm: ""

  pre_tasks:
    # ------------------------------------------------------------
    # SAFETY & PLATFORM ASSERTIONS
    # ------------------------------------------------------------
    - name: Assert supported OS
      assert:
        that:
          - ansible_facts['distribution'] == "Ubuntu"
          - ansible_facts['distribution_version'] is version("22.04", ">=")
        fail_msg: "Only Ubuntu 22.04+ supported"

    - name: Fail if destructive Docker wipe is not explicitly confirmed
      assert:
        that:
          - docker_wipe_confirm == "DESTROY-DOCKER-DATA"
        fail_msg: >
          Refusing to wipe Docker data. To enable, set:
          docker_allow_data_wipe=true AND docker_wipe_confirm=DESTROY-DOCKER-DATA
      when: docker_allow_data_wipe | bool

  tasks:
    # ------------------------------------------------------------
    # SYSTEM
    # ------------------------------------------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - ufw
          - cron
        state: present

    - name: Set timezone
      timezone:
        name: "{{ timezone }}"

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 1: Remove only conflicting Ubuntu packages
    # ------------------------------------------------------------
    - name: Remove conflicting Docker packages (SAFE)
      apt:
        name:
          - docker
          - docker-engine
          - docker.io
        state: absent

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 2: Repo + install (clean, idempotent)
    # ------------------------------------------------------------
    - name: Remove legacy Docker repo/key conflicts
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/docker.list
        - /etc/apt/sources.list.d/docker-ce.list
        - /etc/apt/keyrings/docker.gpg
        - /etc/apt/keyrings/docker.asc

    - name: Create Docker keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Docker GPG key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
        state: present
        filename: docker

    - name: Update apt cache after Docker repo
      apt:
        update_cache: yes

    - name: Install Docker Engine and plugins
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 3: OPTIONAL DESTRUCTIVE WIPE (EXPLICIT ONLY)
    # ------------------------------------------------------------
    - name: Check if Docker service exists
      stat:
        path: /lib/systemd/system/docker.service
      register: docker_service

    - block:
        - name: Stop Docker before wipe
          systemd:
            name: docker
            state: stopped

        - name: Remove ALL Docker data (DESTRUCTIVE)
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /var/lib/docker
            - /var/lib/containerd

        - name: Recreate Docker directories
          file:
            path: "{{ item }}"
            state: directory
            mode: "0755"
          loop:
            - /var/lib/docker
            - /var/lib/containerd

      when:
        - docker_allow_data_wipe | bool
        - docker_service.stat.exists

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 4: Enable runtime (check-mode safe)
    # ------------------------------------------------------------
    - name: Check if docker binary exists
      stat:
        path: /usr/bin/docker
      register: docker_binary

    - name: Enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
      when:
        - docker_binary.stat.exists
        - not ansible_check_mode

    # ------------------------------------------------------------
    # FIREWALL
    # ------------------------------------------------------------
    - name: Allow SSH
      ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Allow HTTP
      ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Allow HTTPS
      ufw:
        rule: allow
        port: "443"
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny

    # ------------------------------------------------------------
    # DIRECTORIES (base)
    # ------------------------------------------------------------
    - name: Create project directories
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ project_directory }}"
        - "{{ project_directory }}/data"
        - "{{ project_directory }}/data/code-server"
        - "{{ project_directory }}/data/code-server/projects"
        - "{{ project_directory }}/data/code-server/config"
        - "{{ project_directory }}/data/nginx"
        - "{{ project_directory }}/data/nginx/conf.d"
        - "{{ project_directory }}/data/nginx/certbot"
        - "{{ project_directory }}/data/nginx/letsencrypt"
        - "{{ project_directory }}/data/nginx/cache"
        - "{{ project_directory }}/data/nginx/run"
        - "{{ project_directory }}/scripts"
        - "{{ backup_directory }}"

    # ------------------------------------------------------------
    # DIRECTORIES (container UID/GID hardening)
    # ------------------------------------------------------------
    - name: Set correct ownership for container volumes
      file:
        path: "{{ item.path }}"
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ project_directory }}/data/code-server/projects", owner: "1000", group: "1000", mode: "0755" }
        - { path: "{{ project_directory }}/data/code-server/config",   owner: "1000", group: "1000", mode: "0755" }
        - { path: "{{ project_directory }}/data/nginx/cache",           owner: "101",  group: "101",  mode: "0755" }
        - { path: "{{ project_directory }}/data/nginx/run",             owner: "101",  group: "101",  mode: "0755" }
      when: not ansible_check_mode

    # ------------------------------------------------------------
    # CONFIG FILES
    # ------------------------------------------------------------
    - name: Deploy docker-compose.yml
      template:
        src: ../docker/docker-compose.yml.j2
        dest: "{{ project_directory }}/docker-compose.yml"
        mode: "0644"

    - name: Deploy nginx.conf
      template:
        src: ../docker/nginx.conf.j2
        dest: "{{ project_directory }}/data/nginx/conf.d/vscode.conf"
        mode: "0644"

    # ------------------------------------------------------------
    # CERTBOT BOOTSTRAP SCRIPT
    # ------------------------------------------------------------
    - name: Install Let's Encrypt bootstrap script
      copy:
        src: ../scripts/init-letsencrypt.sh
        dest: "{{ project_directory }}/scripts/init-letsencrypt.sh"
        mode: "0755"

    # ------------------------------------------------------------
    # BACKUP SCRIPT
    # ------------------------------------------------------------
    - name: Install backup script
      copy:
        src: ../scripts/backup.sh
        dest: "{{ project_directory }}/scripts/backup.sh"
        mode: "0755"

    - name: Install daily backup cron job
      cron:
        name: "Daily VS Code Server backup"
        minute: "15"
        hour: "2"
        job: "{{ project_directory }}/scripts/backup.sh"

    # ------------------------------------------------------------
    # CERTBOT RENEWAL
    # ------------------------------------------------------------
    - name: Install certificate renewal cron job
      cron:
        name: "Renew Let's Encrypt certificates"
        minute: "0"
        hour: "3"
        job: >
          cd {{ project_directory }} &&
          docker compose run --rm certbot renew --quiet &&
          docker compose exec nginx nginx -s reload

    # ------------------------------------------------------------
    # START SERVICES
    # ------------------------------------------------------------
    - name: Start Docker stack
      command: docker compose up -d
      args:
        chdir: "{{ project_directory }}"
      register: compose_result
      changed_when: "'Started' in compose_result.stdout or 'Recreated' in compose_result.stdout"

    - name: Wait for nginx to be ready before certificate bootstrap
      wait_for:
        port: 80
        host: "{{ ansible_default_ipv4.address }}"
        timeout: 30
      when: compose_result.changed

    - name: Bootstrap TLS certificates
      command: "{{ project_directory }}/scripts/init-letsencrypt.sh"
      args:
        creates: "{{ project_directory }}/data/nginx/letsencrypt/live/{{ domain_name }}/fullchain.pem"

    - name: Wait for HTTPS to be reachable
      wait_for:
        host: "{{ domain_name }}"
        port: 443
        timeout: 60

    # ------------------------------------------------------------
    # OUTPUT
    # ------------------------------------------------------------
    - name: Deployment summary
      debug:
        msg:
          - "‚úÖ VS Code Server deployed successfully"
          - "üåê URL: https://{{ domain_name }}"
          - "üìÅ Project path: {{ project_directory }}"
          - "üîß Status: docker compose -f {{ project_directory }}/docker-compose.yml ps"
          - "üìú Logs: docker compose -f {{ project_directory }}/docker-compose.yml logs -f"
