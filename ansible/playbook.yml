---
- name: Deploy Production VS Code Server with Nginx & Let's Encrypt
  hosts: vscode_servers
  become: true

  vars:
    # ============================================================
    # USER CONFIGURATION - CHANGE THESE FOR EACH DEPLOYMENT
    # ============================================================
    domain_name: "{{ deployment_domain | default('ide.example.com') }}"
    admin_email: "{{ deployment_email | default('admin@example.com') }}"

    # ============================================================
    # AUTHELIA CONFIGURATION
    # ============================================================
    authelia_dir: "/opt/vscode-server/data/authelia"
    authelia_config: "/opt/vscode-server/data/authelia/configuration.yml"
    authelia_users: "/opt/vscode-server/data/authelia/users_database.yml"
    authelia_jwt_secret: "/opt/vscode-server/data/authelia/secrets/jwt_secret"
    authelia_session_secret: "/opt/vscode-server/data/authelia/secrets/session_secret"
    authelia_storage_secret: "/opt/vscode-server/data/authelia/secrets/storage_secret"

    # ============================================================
    # INFRASTRUCTURE CONFIGURATION
    # ============================================================
    project_directory: "/opt/vscode-server"
    timezone: "UTC"
    letsencrypt_environment: "{{ letsencrypt_env | default('production') }}"
    backup_directory: "/var/backups/vscode-server"

    # üîí SAFETY CONTROLS
    docker_allow_data_wipe: false
    docker_wipe_confirm: ""

  pre_tasks:
    # ------------------------------------------------------------
    # MULTI-USER PASSWORD HANDLING
    # ------------------------------------------------------------
    - name: Prompt for admin password if users not provided
      vars:
        admin_password: "{{ lookup('password', prompt='Enter password for admin user:', confirm=True) }}"
      set_fact:
        vscode_users:
          admin: "{{ admin_password }}"
      when:
        - vscode_users is not defined
        - not ansible_check_mode
      no_log: true

    - name: Validate users defined
      assert:
        that:
          - vscode_users is defined
          - vscode_users | length > 0
        fail_msg: |
          You must define at least one user:
          --extra-vars 'vscode_users={"alice":"pass1","bob":"pass2"}'

    - name: Validate domain and email
      assert:
        that:
          - domain_name != 'ide.example.com'
          - admin_email != 'admin@example.com'
          - "'@' in admin_email"

    # ------------------------------------------------------------
    # PLATFORM SAFETY
    # ------------------------------------------------------------
    - name: Assert supported OS
      assert:
        that:
          - ansible_facts['distribution'] == "Ubuntu"
          - ansible_facts['distribution_version'] is version("22.04", ">=")
        fail_msg: "Only Ubuntu 22.04+ supported"

    - name: Fail if destructive Docker wipe is not explicitly confirmed
      assert:
        that:
          - docker_wipe_confirm == "DESTROY-DOCKER-DATA"
        fail_msg: >
          Refusing to wipe Docker data. To enable, set:
          docker_allow_data_wipe=true AND docker_wipe_confirm=DESTROY-DOCKER-DATA
      when: docker_allow_data_wipe | bool

  tasks:
    # ------------------------------------------------------------
    # SYSTEM
    # ------------------------------------------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - ufw
          - cron
          - apache2-utils
          - whois
        state: present

    # ------------------------------------------------------------
    # üîê ARGON2 SUPPORT (CONTROLLER GUARANTEE)
    # ------------------------------------------------------------
    - name: Install Argon2 system libraries
      apt:
        name:
          - libargon2-1
          - argon2
        state: present

    - name: Install Python argon2 bindings for Ansible password_hash
      apt:
        name: python3-argon2
        state: present

    - name: Verify Argon2 hashing is available
      command: python3 - <<'EOF'
      from argon2 import PasswordHasher
      PasswordHasher().hash("test")
      print("argon2 ok")
      EOF
      changed_when: false

    - name: Set timezone
      timezone:
        name: "{{ timezone }}"

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 1: Remove only conflicting packages (SAFE)
    # ------------------------------------------------------------
    - name: Check for conflicting docker packages
      shell: dpkg -l | grep -E '^ii\s+(docker|docker-engine|docker.io)\s' || true
      register: docker_conflicts
      changed_when: false

    - name: Remove conflicting Docker packages
      apt:
        name:
          - docker
          - docker-engine
          - docker.io
        state: absent
      when: docker_conflicts.stdout != ""

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 2: Repo + install
    # ------------------------------------------------------------
    - name: Remove legacy Docker repo/key conflicts
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/docker.list
        - /etc/apt/sources.list.d/docker-ce.list
        - /etc/apt/keyrings/docker.gpg
        - /etc/apt/keyrings/docker.asc

    - name: Create Docker keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Docker GPG key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename | default('jammy') }} stable"
        state: present
        filename: docker

    - name: Update apt cache after Docker repo
      apt:
        update_cache: yes

    - name: Install Docker Engine and plugins
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 3: OPTIONAL DESTRUCTIVE WIPE
    # ------------------------------------------------------------
    - name: Check if Docker service exists
      stat:
        path: /lib/systemd/system/docker.service
      register: docker_service

    - block:
        - name: Stop Docker before wipe
          systemd:
            name: docker
            state: stopped

        - name: Remove ALL Docker data (DESTRUCTIVE)
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /var/lib/docker
            - /var/lib/containerd

        - name: Recreate Docker directories
          file:
            path: "{{ item }}"
            state: directory
            mode: "0755"
          loop:
            - /var/lib/docker
            - /var/lib/containerd
      when:
        - docker_allow_data_wipe | bool
        - docker_service.stat.exists

    # ------------------------------------------------------------
    # DOCKER ‚Äî PHASE 4: Enable runtime
    # ------------------------------------------------------------
    - name: Enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
      when: not ansible_check_mode

    - name: Add user to docker group
      user:
        name: "{{ ansible_facts.user_id }}"
        groups: docker
        append: yes
      register: docker_group_change

    - name: Notify docker group membership change
      debug:
        msg: "‚ö†Ô∏è Docker group membership updated. Log out and back in for docker CLI access."
      when:
        - docker_group_change.changed
        - not ansible_check_mode

    # ------------------------------------------------------------
    # FIREWALL
    # ------------------------------------------------------------
    - name: Allow SSH
      ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Allow HTTP
      ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Allow HTTPS
      ufw:
        rule: allow
        port: "443"
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny

    # ------------------------------------------------------------
    # DIRECTORIES
    # ------------------------------------------------------------
    - name: Create project directories
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ project_directory }}"
        - "{{ project_directory }}/data"
        - "{{ project_directory }}/data/code-server"
        - "{{ project_directory }}/data/code-server/projects"
        - "{{ project_directory }}/data/code-server/config"
        - "{{ project_directory }}/data/nginx"
        - "{{ project_directory }}/data/nginx/conf.d"
        - "{{ project_directory }}/data/nginx/certbot"
        - "{{ project_directory }}/data/nginx/letsencrypt"
        - "{{ project_directory }}/data/nginx/cache"
        - "{{ project_directory }}/data/nginx/run"
        - "{{ project_directory }}/data/nginx/letsencrypt/logs"
        - "{{ project_directory }}/data/nginx/auth"
        - "{{ project_directory }}/scripts"
        - "{{ backup_directory }}"
        - "{{ project_directory }}/data/authelia"
        - "{{ project_directory }}/data/authelia/config"
        - "{{ project_directory }}/data/authelia/storage"
        - "{{ project_directory }}/data/authelia/secrets"

    # ------------------------------------------------------------
    # DIRECTORY OWNERSHIP (HARDENED)
    # ------------------------------------------------------------
    - name: Set correct ownership for container volumes
      file:
        path: "{{ item.path }}"
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ project_directory }}/data/code-server/projects", owner: "1000", group: "1000", mode: "0755" }
        - { path: "{{ project_directory }}/data/code-server/config",   owner: "1000", group: "1000", mode: "0755" }
        - { path: "{{ project_directory }}/data/nginx/cache",           owner: "101",  group: "101",  mode: "0755" }
        - { path: "{{ project_directory }}/data/nginx/run",             owner: "101",  group: "101",  mode: "0755" }
        - { path: "{{ project_directory }}/data/nginx/letsencrypt/logs", owner: "0", group: "0", mode: "0755" }
        - { path: "{{ project_directory }}/data/nginx/auth",             owner: "0", group: "0", mode: "0750" }
        - { path: "{{ project_directory }}/data/authelia",               owner: "1000", group: "1000", mode: "0750" }
        - { path: "{{ project_directory }}/data/authelia/config",        owner: "1000", group: "1000", mode: "0750" }
        - { path: "{{ project_directory }}/data/authelia/storage",       owner: "1000", group: "1000", mode: "0750" }
        - { path: "{{ project_directory }}/data/authelia/secrets",       owner: "1000", group: "1000", mode: "0700" }

    - name: Create nginx runtime directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "101"
        group: "101"
        mode: "0755"
      loop:
        - /opt/vscode-server/data/nginx/cache/client_temp
        - /opt/vscode-server/data/nginx/cache/proxy_temp
        - /opt/vscode-server/data/nginx/cache/fastcgi_temp
        - /opt/vscode-server/data/nginx/cache/uwsgi_temp
        - /opt/vscode-server/data/nginx/cache/scgi_temp
        - /opt/vscode-server/data/nginx/run

    # ------------------------------------------------------------
    # AUTHELIA SECRETS (FILES, NOT INLINE)
    # ------------------------------------------------------------
    - name: Generate Authelia secrets if missing
      copy:
        dest: "{{ item }}"
        content: "{{ lookup('password', '/dev/null length=64 chars=ascii_letters,digits') }}"
        mode: "0600"
        force: no
      loop:
        - "{{ authelia_jwt_secret }}"
        - "{{ authelia_session_secret }}"
        - "{{ authelia_storage_secret }}"
      no_log: true

    # ------------------------------------------------------------
    # AUTHELIA PASSWORD HASHING (ARGON2ID)
    # ------------------------------------------------------------
    - name: Generate Argon2id password hashes
      command: >
        mkpasswd --method=argon2id {{ item.value }}
      loop: "{{ vscode_users | dict2items }}"
      register: authelia_hashes
      no_log: true
      changed_when: false

    - name: Build Authelia users dictionary
      set_fact:
        authelia_users_hashed: "{{ authelia_users_hashed | default({}) | combine({item.item.key: item.stdout}) }}"
      loop: "{{ authelia_hashes.results }}"
      no_log: true

    # ------------------------------------------------------------
    # AUTHELIA USERS DATABASE
    # ------------------------------------------------------------
    - name: Deploy Authelia users database
      template:
        src: ../authelia/users_database.yml.j2
        dest: "{{ authelia_users }}"
        mode: "0600"
      vars:
        authelia_users: "{{ authelia_users_hashed }}"
      no_log: true

    # ------------------------------------------------------------
    # AUTHELIA CONFIGURATION
    # ------------------------------------------------------------
    - name: Deploy Authelia configuration
      template:
        src: ../authelia/configuration.yml.j2
        dest: "{{ authelia_config }}"
        mode: "0600"

    # ------------------------------------------------------------
    # CONFIG FILES
    # ------------------------------------------------------------
    - name: Deploy docker-compose.yml
      template:
        src: ../docker/docker-compose.yml.j2
        dest: "{{ project_directory }}/docker-compose.yml"
        mode: "0644"
      no_log: true

    - name: Deploy nginx.conf
      template:
        src: ../docker/nginx.conf.j2
        dest: "{{ project_directory }}/data/nginx/conf.d/vscode.conf"
        mode: "0644"

    # ------------------------------------------------------------
    # CERTBOT BOOTSTRAP SCRIPT
    # ------------------------------------------------------------
    - name: Install Let's Encrypt bootstrap script
      template:
        src: ../scripts/init-letsencrypt.sh.j2
        dest: "{{ project_directory }}/scripts/init-letsencrypt.sh"
        mode: "0755"

    # ------------------------------------------------------------
    # BACKUP
    # ------------------------------------------------------------
    - name: Install backup script
      copy:
        src: ../scripts/backup.sh
        dest: "{{ project_directory }}/scripts/backup.sh"
        mode: "0755"

    - name: Install daily backup cron job
      cron:
        name: "Daily VS Code Server backup"
        minute: "15"
        hour: "2"
        job: "{{ project_directory }}/scripts/backup.sh"

    # ------------------------------------------------------------
    # CERTIFICATE RENEWAL
    # ------------------------------------------------------------
    - name: Install certificate renewal script
      template:
        src: ../scripts/renew-certs.sh.j2
        dest: "{{ project_directory }}/scripts/renew-certs.sh"
        mode: "0755"

    - name: Install certificate renewal cron job
      cron:
        name: "Renew Let's Encrypt certificates"
        minute: "0"
        hour: "3"
        job: "{{ project_directory }}/scripts/renew-certs.sh"

    - name: Create certbot runtime directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "0"
        group: "0"
        mode: "0755"
      loop:
        - /opt/vscode-server/data/nginx/letsencrypt/logs
        - /opt/vscode-server/data/nginx/letsencrypt/work

    # ------------------------------------------------------------
    # START SERVICES
    # ------------------------------------------------------------
    - name: Start Docker stack
      command: docker compose up -d
      args:
        chdir: "{{ project_directory }}"
      register: compose_result

    # ------------------------------------------------------------
    # CERTIFICATE BOOTSTRAP
    # ------------------------------------------------------------
    - name: Check if SSL certificate already exists
      stat:
        path: "{{ project_directory }}/data/nginx/letsencrypt/live/{{ domain_name }}/fullchain.pem"
      register: ssl_cert_exists

    - name: Bootstrap TLS certificates
      command: "{{ project_directory }}/scripts/init-letsencrypt.sh"
      args:
        chdir: "{{ project_directory }}"
      when: not ssl_cert_exists.stat.exists
      register: certbot_result
      changed_when: certbot_result.rc == 0

    # ------------------------------------------------------------
    # FINAL VERIFICATION
    # ------------------------------------------------------------
    - name: Wait for services to stabilize
      pause:
        seconds: 10

    - name: Verify nginx is running
      command: docker compose ps nginx
      args:
        chdir: "{{ project_directory }}"
      changed_when: false

    - name: Verify code-server is running
      command: docker compose ps code-server
      args:
        chdir: "{{ project_directory }}"
      changed_when: false

    # ------------------------------------------------------------
    # OUTPUT
    # ------------------------------------------------------------
    - name: Deployment summary
      debug:
        msg:
          - "============================================================"
          - "‚úÖ VS Code Server deployed successfully"
          - "============================================================"
          - "üåê Domain: {{ domain_name }}"
          - "üìß Admin email: {{ admin_email }}"
          - "üîê Environment: {{ letsencrypt_environment }}"
          - "üìÅ Project path: {{ project_directory }}"
          - "üîß Status: docker compose -f {{ project_directory }}/docker-compose.yml ps"
          - "üìú Logs: docker compose -f {{ project_directory }}/docker-compose.yml logs -f"
          - ""
          - "üìã Access Information:"
          - "   HTTPS URL: https://{{ domain_name }}/"
          - "   Auth: Authelia multi-user login (with logout + session timeout)"
          - ""
          - "üîß Management Commands:"
          - "   Start/Stop: cd {{ project_directory }} && docker compose [up/down]"
          - "   View logs: cd {{ project_directory }} && docker compose logs -f"
          - "   Backup: {{ project_directory }}/scripts/backup.sh"
          - "   Renew certs: {{ project_directory }}/scripts/renew-certs.sh"
          - "============================================================"
