services:
  code-server:
    image: "{{ code_server_image | default('codercom/code-server:4.108.1') }}"
    container_name: code-server
    restart: unless-stopped

    user: "1000:1000"
    read_only: true
    cap_drop: [ALL]
    security_opt: [no-new-privileges:true]
    pids_limit: 256
    stop_grace_period: 30s

    command: >
      code-server
      --bind-addr 0.0.0.0:8080
      --auth none
      --disable-telemetry
      /home/coder/project

    environment:
      TZ: UTC
      DEFAULT_WORKSPACE: /home/coder/project

    volumes:
      - ./data/code-server/projects:/home/coder/project:rw
      - ./data/code-server/config:/home/coder/.config:rw

    tmpfs:
      - /tmp
      - /run

    expose:
      - "8080"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    networks: [vscode-net]

  authelia:
    image: authelia/authelia:4.39.15
    container_name: authelia
    restart: unless-stopped

    user: "1000:1000"
    read_only: true
    cap_drop: [ALL]
    security_opt: [no-new-privileges:true]
    pids_limit: 128
    stop_grace_period: 15s

    command: >
      authelia
      --config /config/configuration.yml

    volumes:
      # Configuration + users database (read-only)
      - ./data/authelia/config:/config:ro

      # SQLite storage backend
      - ./data/authelia/storage:/var/lib/authelia:rw

      # Notification output (filesystem notifier)
      - ./data/authelia/notifications:/var/lib/authelia/notifications:rw

      # Runtime socket directory for nginx auth_request
      - ./data/authelia/run:/run/authelia:rw

      # Secrets (jwt/session/storage encryption keys)
      - ./data/authelia/secrets:/secrets:ro

    environment:
      AUTHELIA_JWT_SECRET_FILE: /secrets/jwt_secret
      AUTHELIA_SESSION_SECRET_FILE: /secrets/session_secret
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: /secrets/storage_secret

    tmpfs:
      - /tmp

    expose:
      - "9091"

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    networks: [vscode-net]

  nginx:
    image: "{{ nginx_image | default('nginx:1.28.1-alpine') }}"
    container_name: nginx-proxy
    restart: unless-stopped

    user: "0:0"

    read_only: true
    cap_drop: [ALL]
    cap_add:
      - NET_BIND_SERVICE
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    security_opt: [no-new-privileges:true]
    pids_limit: 128
    stop_grace_period: 15s

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./data/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./data/nginx/certbot:/var/www/certbot:ro
      - ./data/nginx/letsencrypt:/etc/letsencrypt:ro
      - ./data/nginx/cache:/var/cache/nginx:rw
      - ./data/nginx/run:/var/run:rw
      - ./data/authelia/run:/run/authelia:ro

    tmpfs:
      - /tmp

    depends_on:
      code-server:
        condition: service_healthy
      authelia:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/.healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    networks: [vscode-net]

  certbot:
    image: "{{ certbot_image | default('certbot/certbot:v2.10.0') }}"
    container_name: certbot
    restart: "no"

    cap_drop: [ALL]
    security_opt: [no-new-privileges:true]
    pids_limit: 64

    volumes:
      - ./data/nginx/letsencrypt:/etc/letsencrypt:rw
      - ./data/nginx/certbot:/var/www/certbot:rw
      - ./data/nginx/cache:/var/cache/nginx:rw
      - ./data/nginx/run:/var/run:rw
      - /etc/ssl/certs:/etc/ssl/certs:ro

    tmpfs:
      - /tmp

    entrypoint: certbot
    networks: [vscode-net]

networks:
  vscode-net:
    driver: bridge
