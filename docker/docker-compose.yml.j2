services:
  code-server:
    image: "{{ code_server_image | default('codercom/code-server:4.108.1') }}"
    container_name: code-server
    restart: unless-stopped

    user: "1000:1000"
    read_only: true
    cap_drop: [ALL]
    security_opt: [no-new-privileges:true]
    pids_limit: 256
    stop_grace_period: 30s

    environment:
      TZ: UTC
      PASSWORD_FILE: /run/secrets/code_server_password
      DEFAULT_WORKSPACE: /home/coder/project

    volumes:
      - ./data/code-server/projects:/home/coder/project:rw
      - ./data/code-server/config:/home/coder/.config:rw

    secrets:
      - code_server_password

    tmpfs:
      - /tmp
      - /run

    expose:
      - "8080"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    networks: [vscode-net]

  nginx:
    image: "{{ nginx_image | default('nginx:1.28.1-alpine') }}"
    container_name: nginx-proxy
    restart: unless-stopped

    # MUST run as root to read TLS private keys
    user: "0:0"

    read_only: true
    cap_drop: [ALL]
    cap_add:
      - NET_BIND_SERVICE
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    security_opt: [no-new-privileges:true]
    pids_limit: 128
    stop_grace_period: 15s

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./data/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./data/nginx/certbot:/var/www/certbot:ro
      - ./data/nginx/letsencrypt:/etc/letsencrypt:ro
      - ./data/nginx/letsencrypt/logs:/var/log/certbot:rw
      - ./data/nginx/letsencrypt/work:/var/lib/certbot:rw
      - ./data/nginx/cache:/var/cache/nginx:rw
      - ./data/nginx/run:/var/run:rw

    tmpfs:
      - /tmp

    depends_on:
      code-server:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "curl -k -f https://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks: [vscode-net]

  certbot:
    image: "{{ certbot_image | default('certbot/certbot:v2.10.0') }}"
    container_name: certbot
    restart: "no"

    cap_drop: [ALL]
    security_opt: [no-new-privileges:true]
    pids_limit: 64

    volumes:
      - ./data/nginx/letsencrypt:/etc/letsencrypt:rw
      - ./data/nginx/certbot:/var/www/certbot:rw
      - ./data/nginx/letsencrypt/logs:/var/log/certbot:rw
      - ./data/nginx/letsencrypt/work:/var/lib/certbot:rw
      - /etc/ssl/certs:/etc/ssl/certs:ro

    tmpfs:
      - /tmp

    entrypoint: certbot
    networks: [vscode-net]

secrets:
  code_server_password:
    file: ./secrets/code_server_password

networks:
  vscode-net:
    driver: bridge
