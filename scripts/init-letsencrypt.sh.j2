#!/usr/bin/env bash
set -euo pipefail

DOMAIN="{{ deployment_domain }}"
EMAIL="{{ deployment_email }}"
STAGING="${letsencrypt_env:-}"

BASE="/opt/vscode-server"
DATA_PATH="$BASE/data/nginx"

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

if [[ -z "$DOMAIN" || -z "$EMAIL" ]]; then
  echo "‚ùå DOMAIN or EMAIL not set"
  exit 1
fi

cd "$BASE"

if [[ -d "$DATA_PATH/letsencrypt/live/$DOMAIN" ]]; then
  log "‚úÖ Existing certificate found for $DOMAIN ‚Äî skipping bootstrap"
  exit 0
fi

log "üöÄ Starting nginx for ACME challenge..."
docker compose up -d nginx

log "‚è≥ Waiting for nginx to bind port 80..."
for i in {1..30}; do
  if ss -ltn sport = :80 >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

if ! ss -ltn sport = :80 >/dev/null 2>&1; then
  log "‚ùå nginx did not become ready"
  docker compose logs nginx || true
  exit 1
fi

log "üìú Requesting certificate for $DOMAIN..."

STAGING_ARGS=""
if [[ "$STAGING" == "staging" ]]; then
  STAGING_ARGS="--staging"
fi

LOG_DIR="/var/log/certbot"
WORK_DIR="/var/lib/certbot"
CONFIG_DIR="/etc/letsencrypt"

docker compose run --rm --user 0:0 certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email "$EMAIL" \
  --agree-tos \
  --no-eff-email \
  --logs-dir "$LOG_DIR" \
  --work-dir "$WORK_DIR" \
  --config-dir "$CONFIG_DIR" \
  $STAGING_ARGS \
  -d "$DOMAIN"

log "üîÑ Reloading nginx with certificates..."
docker compose exec nginx nginx -s reload

log "‚úÖ Certificate bootstrap complete"
