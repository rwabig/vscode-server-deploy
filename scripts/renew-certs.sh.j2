#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# CONFIGURATION
# ============================================================
BASE="/opt/vscode-server"
LOG_FILE="/var/log/certbot-renew.log"

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

cd "$BASE"

log "Starting certificate renewal check..."

# Attempt renewal (certbot only renews if needed)
if docker compose run --rm certbot renew --quiet \
  --logs-dir /var/log/certbot \
  --work-dir /var/lib/certbot \
  --config-dir /etc/letsencrypt; then
  log "Certificate renewal check complete"
else
  log "❌ Certificate renewal failed"
  exit 1
fi

# Reload nginx only if running
if docker compose ps nginx | grep -q "Up"; then
  if docker compose exec nginx nginx -s reload; then
    log "Nginx reloaded successfully"
  else
    log "⚠️  Nginx reload failed"
  fi
fi

log "Renewal job finished"
